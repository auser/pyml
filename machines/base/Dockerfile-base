


# DO NOT MODIFY THIS AUTOGENERATED FILE
# Change ./machines/base/Dockerfile-base.m4

# FROM ubuntu:trusty
FROM nvidia/cuda:7.5-cudnn4-devel

ENV DEBIAN_FRONTEND noninteractive
ENV INSTALL_ROOT /usr/local/src
ENV CONDA_DIR /opt/conda

COPY system-conf /

# Install common utilities
# python-software-properties software-properties-common \
# build-essential curl
RUN apt-get -y update && \
    apt-get install -y -q \
    wget \
    build-essential curl \
    cmake \
    git && \
    apt-get autoremove -yq \
      && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN locale-gen en_US en_US.UTF-8
RUN dpkg-reconfigure locales


## CLEANUP


# Configure environment
ENV CONDA_DIR /opt/conda
ENV PATH $CONDA_DIR/bin:$PATH
ENV SHELL /bin/bash
ENV USER_LOGIN ${USER_LOGIN:-compute}
ENV USER_UID ${USER_UID:-1000}

ENV LC_ALL en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US.UTF-8

ENV USER_FULL_NAME "${USER_FULL_NAME:-Compute container user}"
ENV USER_DIR "/home/${USER_LOGIN}"
ENV PASSWORD ${PASSWORD:-itsginger}
ENV PYTHON_ENV ${PYTHON_ENV:-py2}

ENV NOTEBOOK_PORT ${PORT:-8888}

ENV JDIR "${USER_DIR}/.jupyter"
ENV CONF_FILE "${JDIR}/jupyter_notebook_config.py"

# Create ${USER_LOGIN} user with UID=${USER_UID} and in the 'users' group
RUN useradd -m -s /bin/bash -u $USER_UID $USER_LOGIN && \
    mkdir -p $CONDA_DIR && \
    chown $USER_LOGIN $CONDA_DIR

RUN rm /bin/sh && ln -s /bin/bash /bin/sh

RUN apt-get update --fix-missing && apt-get install -y wget bzip2 ca-certificates \
  libglib2.0-0 libxext6 libsm6 libxrender1 \
  git mercurial subversion && \
  apt-get autoremove -yq \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN echo 'export PATH=/opt/conda/bin:$PATH' > /etc/profile.d/conda.sh && \
  wget --quiet https://repo.continuum.io/miniconda/Miniconda2-4.0.5-Linux-x86_64.sh && \
  /bin/bash /Miniconda2-4.0.5-Linux-x86_64.sh -f -b -p /opt/conda && \
  conda clean -i -l -t -y && \
  rm Miniconda2-4.0.5-Linux-x86_64.sh

RUN apt-get install -y curl grep sed dpkg && \
  TINI_VERSION=$(curl https://github.com/krallin/tini/releases/latest | grep -o "/v.*\"" | sed 's:^..\(.*\).$:\1:') && \
  curl -L "https://github.com/krallin/tini/releases/download/v${TINI_VERSION}/tini_${TINI_VERSION}.deb" > tini.deb && \
  dpkg -i tini.deb && \
  rm tini.deb && \
  apt-get autoremove -yq \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENV PATH /opt/conda/bin:$PATH

ENTRYPOINT [ "/usr/bin/tini", "--" ]z
ENV PATH $CONDA_DIR/bin:$PATH

# libav-tools for matplotlib anim
RUN apt-get update -qq && \
    apt-get install -qy --no-install-recommends --force-yes \
      libav-tools \
      libhdf5-dev graphviz libhdf5-dev \
      libfreetype6-dev libpng12-dev \
      pkg-config build-essential cmake git \
      libx11-dev \
      unzip; \
    apt-get autoremove -yq \
      && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install Python 3 packages
RUN $CONDA_DIR/bin/conda create --quiet --yes -n py3 python=3.4 && \
    $CONDA_DIR/bin/conda create --quiet --yes -n py2 python=2.7

# http://bugs.python.org/issue19846
# > At the moment, setting "LANG=C" on a Linux system *fundamentally breaks Python 3*, and that's not OK.
ENV LANG C.UTF-8

COPY requirements.txt /tmp/requirements.txt
RUN source activate py2 && \
    $CONDA_DIR/bin/pip install --upgrade -I setuptools && \
    $CONDA_DIR/bin/conda install --yes \
    'cython=0.23*' \
    'setuptools' \
    'numpy' \
    'statsmodels' && \
    pip install --upgrade ipykernel jupyter notebook --ignore-installed && \
    ipython kernel install && \
    pip install --upgrade -r /tmp/requirements.txt --ignore-installed

RUN source activate py3 && \
    $CONDA_DIR/bin/pip install --upgrade -I setuptools && \
    $CONDA_DIR/bin/conda install --yes \
    'cython=0.23*' \
    'setuptools' \
    'numpy' \
    'statsmodels' && \
    pip install --upgrade ipykernel jupyter notebook --ignore-installed && \
    ipython kernel install && \
    pip install --upgrade -r /tmp/requirements.txt --ignore-installed

RUN cp -r $HOME/.conda /etc/skel/.conda

ENV PY2_SITE_PACKAGES $($PY2_DIR/bin/python -c "import site;print(site.getsitepackages()[0])")
ENV PY3_SITE_PACKAGES $($PY3_DIR/bin/python -c "import site;print(site.getsitepackages()[0])")